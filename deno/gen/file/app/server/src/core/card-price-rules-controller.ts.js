export class CardPriceRulesController {
  cardLibrary;
  match;
  _rules;
  constructor(cardLibrary, match){
    this.cardLibrary = cardLibrary;
    this.match = match;
    this._rules = {};
  }
  registerRule(card, rule) {
    this._rules[card.id] ??= [];
    this._rules[card.id].push(rule);
    return ()=>{
      const idx = this._rules[card.id].findIndex((r)=>r === rule);
      if (idx !== -1) {
        this._rules[card.id].splice(idx, 1);
      }
      return void 0;
    };
  }
  applyRules(card, { playerId }) {
    let restricted = false;
    let modifiedCost = {
      ...card.cost
    };
    const rules = this._rules[card.id];
    if (!rules) {
      return {
        restricted,
        cost: modifiedCost
      };
    }
    for (const rule of rules){
      const result = rule(card, {
        match: this.match,
        playerId
      });
      restricted ||= result.restricted;
      modifiedCost = {
        treasure: Math.max(0, modifiedCost.treasure + (result.cost.treasure ?? 0)),
        potion: Math.max(0, (modifiedCost.potion ?? 0) + (result.cost.potion ?? 0))
      };
    }
    return {
      restricted,
      cost: modifiedCost
    };
  }
  calculateOverrides() {
    const costOverrides = {};
    const cards = this.cardLibrary.getAllCardsAsArray();
    for (const player of this.match.players){
      for (const card of cards){
        const { cost } = this.applyRules(card, {
          playerId: player.id
        });
        costOverrides[player.id] ??= {};
        costOverrides[player.id][card.id] = {
          cost
        };
      }
    }
    return costOverrides;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vYXBwL3NlcnZlci9zcmMvY29yZS9jYXJkLXByaWNlLXJ1bGVzLWNvbnRyb2xsZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2FyZCwgQ2FyZENvc3QsIENhcmRJZCwgQ2FyZExpa2UsIE1hdGNoLCBQbGF5ZXJJZCB9IGZyb20gJ3NoYXJlZC9zaGFyZWQtdHlwZXMudHMnO1xuaW1wb3J0IHsgTWF0Y2hDYXJkTGlicmFyeSB9IGZyb20gJy4vbWF0Y2gtY2FyZC1saWJyYXJ5LnRzJztcblxuZXhwb3J0IHR5cGUgQ2FyZFByaWNlUnVsZSA9IChcbiAgY2FyZDogQ2FyZExpa2UsXG4gIGNvbnRleHQ6IHsgbWF0Y2g6IE1hdGNoLCBwbGF5ZXJJZDogUGxheWVySWQgfVxuKSA9PiAoeyByZXN0cmljdGVkOiBib29sZWFuOyBjb3N0OiBDYXJkQ29zdCB9KTtcblxuZXhwb3J0IGNsYXNzIENhcmRQcmljZVJ1bGVzQ29udHJvbGxlciB7XG4gIHByaXZhdGUgX3J1bGVzOiBSZWNvcmQ8Q2FyZElkLCBDYXJkUHJpY2VSdWxlW10+ID0ge307XG4gIFxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhcmRMaWJyYXJ5OiBNYXRjaENhcmRMaWJyYXJ5LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWF0Y2g6IE1hdGNoLFxuICApIHtcbiAgfVxuICBcbiAgcmVnaXN0ZXJSdWxlKGNhcmQ6IENhcmRMaWtlLCBydWxlOiBDYXJkUHJpY2VSdWxlKSB7XG4gICAgdGhpcy5fcnVsZXNbY2FyZC5pZF0gPz89IFtdO1xuICAgIHRoaXMuX3J1bGVzW2NhcmQuaWRdLnB1c2gocnVsZSk7XG4gICAgXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IGlkeCA9IHRoaXMuX3J1bGVzW2NhcmQuaWRdLmZpbmRJbmRleChyID0+IHIgPT09IHJ1bGUpO1xuICAgICAgaWYgKGlkeCAhPT0gLTEpIHtcbiAgICAgICAgdGhpcy5fcnVsZXNbY2FyZC5pZF0uc3BsaWNlKGlkeCwgMSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdm9pZCAwO1xuICAgIH1cbiAgfVxuICBcbiAgYXBwbHlSdWxlcyhjYXJkOiBDYXJkTGlrZSwgeyBwbGF5ZXJJZCB9OiB7IHBsYXllcklkOiBQbGF5ZXJJZCB9KSB7XG4gICAgbGV0IHJlc3RyaWN0ZWQgPSBmYWxzZTtcbiAgICBsZXQgbW9kaWZpZWRDb3N0ID0geyAuLi5jYXJkLmNvc3QgfTtcbiAgICBcbiAgICBjb25zdCBydWxlcyA9IHRoaXMuX3J1bGVzW2NhcmQuaWRdO1xuICAgIGlmICghcnVsZXMpIHtcbiAgICAgIHJldHVybiB7IHJlc3RyaWN0ZWQsIGNvc3Q6IG1vZGlmaWVkQ29zdCB9O1xuICAgIH1cbiAgICBcbiAgICBmb3IgKGNvbnN0IHJ1bGUgb2YgcnVsZXMpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJ1bGUoY2FyZCwgeyBtYXRjaDogdGhpcy5tYXRjaCwgcGxheWVySWQgfSk7XG4gICAgICBcbiAgICAgIHJlc3RyaWN0ZWQgfHw9IHJlc3VsdC5yZXN0cmljdGVkO1xuICAgICAgXG4gICAgICBtb2RpZmllZENvc3QgPSB7XG4gICAgICAgIHRyZWFzdXJlOiBNYXRoLm1heCgwLCBtb2RpZmllZENvc3QudHJlYXN1cmUgKyAocmVzdWx0LmNvc3QudHJlYXN1cmUgPz8gMCkpLFxuICAgICAgICBwb3Rpb246IE1hdGgubWF4KDAsIChtb2RpZmllZENvc3QucG90aW9uID8/IDApICsgKHJlc3VsdC5jb3N0LnBvdGlvbiA/PyAwKSlcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHsgcmVzdHJpY3RlZCwgY29zdDogbW9kaWZpZWRDb3N0IH07XG4gIH1cbiAgXG4gIGNhbGN1bGF0ZU92ZXJyaWRlcygpIHtcbiAgICBjb25zdCBjb3N0T3ZlcnJpZGVzOiBSZWNvcmQ8UGxheWVySWQsIFJlY29yZDxDYXJkSWQsIFBhcnRpYWw8Q2FyZD4+PiA9IHt9O1xuICAgIFxuICAgIGNvbnN0IGNhcmRzID0gdGhpcy5jYXJkTGlicmFyeS5nZXRBbGxDYXJkc0FzQXJyYXkoKTtcbiAgICBmb3IgKGNvbnN0IHBsYXllciBvZiB0aGlzLm1hdGNoLnBsYXllcnMpIHtcbiAgICAgIGZvciAoY29uc3QgY2FyZCBvZiBjYXJkcykge1xuICAgICAgICBjb25zdCB7IGNvc3QgfSA9XG4gICAgICAgICAgdGhpcy5hcHBseVJ1bGVzKGNhcmQsIHsgcGxheWVySWQ6IHBsYXllci5pZCB9KVxuICAgICAgICBjb3N0T3ZlcnJpZGVzW3BsYXllci5pZF0gPz89IHt9O1xuICAgICAgICBjb3N0T3ZlcnJpZGVzW3BsYXllci5pZF1bY2FyZC5pZF0gPSB7XG4gICAgICAgICAgY29zdFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBjb3N0T3ZlcnJpZGVzO1xuICB9XG59Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVFBLE9BQU8sTUFBTTs7O0VBQ0gsT0FBNkM7RUFFckQsWUFDRSxBQUFpQixXQUE2QixFQUM5QyxBQUFpQixLQUFZLENBQzdCO1NBRmlCLGNBQUE7U0FDQSxRQUFBO1NBSlgsU0FBMEMsQ0FBQztFQU1uRDtFQUVBLGFBQWEsSUFBYyxFQUFFLElBQW1CLEVBQUU7SUFDaEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxLQUFLLEVBQUU7SUFDM0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUUxQixPQUFPO01BQ0wsTUFBTSxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQSxJQUFLLE1BQU07TUFDdEQsSUFBSSxRQUFRLENBQUMsR0FBRztRQUNkLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSztNQUNuQztNQUNBLE9BQU8sS0FBSztJQUNkO0VBQ0Y7RUFFQSxXQUFXLElBQWMsRUFBRSxFQUFFLFFBQVEsRUFBMEIsRUFBRTtJQUMvRCxJQUFJLGFBQWE7SUFDakIsSUFBSSxlQUFlO01BQUUsR0FBRyxLQUFLLElBQUk7SUFBQztJQUVsQyxNQUFNLFFBQVEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNsQyxJQUFJLENBQUMsT0FBTztNQUNWLE9BQU87UUFBRTtRQUFZLE1BQU07TUFBYTtJQUMxQztJQUVBLEtBQUssTUFBTSxRQUFRLE1BQU87TUFDeEIsTUFBTSxTQUFTLEtBQUssTUFBTTtRQUFFLE9BQU8sSUFBSSxDQUFDLEtBQUs7UUFBRTtNQUFTO01BRXhELGVBQWUsT0FBTyxVQUFVO01BRWhDLGVBQWU7UUFDYixVQUFVLEtBQUssR0FBRyxDQUFDLEdBQUcsYUFBYSxRQUFRLEdBQUcsQ0FBQyxPQUFPLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQztRQUN4RSxRQUFRLEtBQUssR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFhLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQztNQUMzRTtJQUNGO0lBRUEsT0FBTztNQUFFO01BQVksTUFBTTtJQUFhO0VBQzFDO0VBRUEscUJBQXFCO0lBQ25CLE1BQU0sZ0JBQWlFLENBQUM7SUFFeEUsTUFBTSxRQUFRLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCO0lBQ2pELEtBQUssTUFBTSxVQUFVLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFFO01BQ3ZDLEtBQUssTUFBTSxRQUFRLE1BQU87UUFDeEIsTUFBTSxFQUFFLElBQUksRUFBRSxHQUNaLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTTtVQUFFLFVBQVUsT0FBTyxFQUFFO1FBQUM7UUFDOUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQztRQUM5QixhQUFhLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxHQUFHO1VBQ2xDO1FBQ0Y7TUFDRjtJQUNGO0lBRUEsT0FBTztFQUNUO0FBQ0YifQ==
// denoCacheMetadata=10673288425817845964,3843560390709574591