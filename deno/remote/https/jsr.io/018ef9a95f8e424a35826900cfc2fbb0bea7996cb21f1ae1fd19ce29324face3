import { after } from '../../function/after.ts';
import { noop } from '../../function/noop.ts';
import { isEqualWith as isEqualWithToolkit } from '../../predicate/isEqualWith.ts';

/**
 * Compares two values for equality using a custom comparison function.
 *
 * The custom function allows for fine-tuned control over the comparison process. If it returns a boolean, that result determines the equality. If it returns undefined, the function falls back to the default equality comparison.
 *
 * This function also uses the custom equality function to compare values inside objects,
 * arrays, maps, sets, and other complex structures, ensuring a deep comparison.
 *
 * This approach provides flexibility in handling complex comparisons while maintaining efficient default behavior for simpler cases.
 *
 * The custom comparison function can take up to six parameters:
 * - `x`: The value from the first object `a`.
 * - `y`: The value from the second object `b`.
 * - `property`: The property key used to get `x` and `y`.
 * - `xParent`: The parent of the first value `x`.
 * - `yParent`: The parent of the second value `y`.
 * - `stack`: An internal stack (Map) to handle circular references.
 *
 * @param {unknown} a - The first value to compare.
 * @param {unknown} b - The second value to compare.
 * @param {(x: any, y: any, property?: PropertyKey, xParent?: any, yParent?: any, stack?: Map<any, any>) => boolean | void} [areValuesEqual=noop] - A function to customize the comparison.
 *   If it returns a boolean, that result will be used. If it returns undefined,
 *   the default equality comparison will be used.
 * @returns {boolean} `true` if the values are equal according to the customizer, otherwise `false`.
 *
 * @example
 * const customizer = (a, b) => {
 *   if (typeof a === 'string' && typeof b === 'string') {
 *     return a.toLowerCase() === b.toLowerCase();
 *   }
 * };
 * isEqualWith('Hello', 'hello', customizer); // true
 * isEqualWith({ a: 'Hello' }, { a: 'hello' }, customizer); // true
 * isEqualWith([1, 2, 3], [1, 2, 3], customizer); // true
 */
export function isEqualWith(
  a: any,
  b: any,
  areValuesEqual: (
    a: any,
    b: any,
    property?: PropertyKey,
    aParent?: any,
    bParent?: any,
    stack?: Map<any, any>
  ) => boolean | void = noop
): boolean {
  if (typeof areValuesEqual !== 'function') {
    areValuesEqual = noop;
  }

  return isEqualWithToolkit(a, b, (...args): boolean | void => {
    const result = areValuesEqual(...args);

    if (result !== undefined) {
      return Boolean(result);
    }

    if (a instanceof Map && b instanceof Map) {
      return isEqualWith(
        Array.from(a),
        Array.from(b),
        // areValuesEqual should not be called for converted values
        after(2, areValuesEqual)
      );
    }

    if (a instanceof Set && b instanceof Set) {
      return isEqualWith(
        Array.from(a),
        Array.from(b),
        // areValuesEqual should not be called for converted values
        after(2, areValuesEqual)
      );
    }
  });
}

// denoCacheMetadata={"headers":{"accept-ranges":"bytes","x-goog-stored-content-encoding":"identity","access-control-expose-headers":"*","cross-origin-resource-policy":"cross-origin","x-goog-metageneration":"1","x-content-type-options":"nosniff","via":"1.1 google","age":"0","x-goog-stored-content-length":"3044","alt-svc":"h3=\":443\"; ma=2592000,h3-29=\":443\"; ma=2592000","etag":"\"36627db897cd07abdfd9c1f7f0fcd4ed\"","x-jsr-cache-id":"ATL","content-length":"3044","server":"UploadServer","last-modified":"Sun, 09 Mar 2025 08:39:35 GMT","access-control-allow-origin":"*","date":"Thu, 26 Jun 2025 21:45:35 GMT","cache-control":"public, max-age=31536000, immutable","content-security-policy":"default-src 'none'; script-src 'none'; style-src 'none'; img-src 'none'; font-src 'none'; connect-src 'none'; frame-src 'none'; object-src 'none'; frame-ancestors 'none'; sandbox; form-action 'none';","expires":"Fri, 26 Jun 2026 21:45:35 GMT","x-robots-tag":"noindex","x-guploader-uploadid":"ABgVH89Y9YkXNEP9gzAYiDW_W1-rQICVgP5nqO8Txz_3HuWM-KjcsjcorREX-Uok7GCgzxaR","x-goog-generation":"1741509575492657","x-goog-hash":"crc32c=uIKS/A==,md5=NmJ9uJfNB6vf2cH38PzU7Q==","x-goog-storage-class":"STANDARD","x-jsr-cache-status":"revalidated","content-type":"text/typescript"},"url":"https://jsr.io/@es-toolkit/es-toolkit/1.33.0/src/compat/predicate/isEqualWith.ts","time":1750974334}