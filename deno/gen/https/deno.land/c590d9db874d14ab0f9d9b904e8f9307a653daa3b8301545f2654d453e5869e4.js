// deno-lint-ignore-file
import { EventEmitter } from "../event-emitter/mod.ts";
import { getLogger } from "../../deps.ts";
export var PacketType = /*#__PURE__*/ function(PacketType) {
  PacketType[PacketType["CONNECT"] = 0] = "CONNECT";
  PacketType[PacketType["DISCONNECT"] = 1] = "DISCONNECT";
  PacketType[PacketType["EVENT"] = 2] = "EVENT";
  PacketType[PacketType["ACK"] = 3] = "ACK";
  PacketType[PacketType["CONNECT_ERROR"] = 4] = "CONNECT_ERROR";
  PacketType[PacketType["BINARY_EVENT"] = 5] = "BINARY_EVENT";
  PacketType[PacketType["BINARY_ACK"] = 6] = "BINARY_ACK";
  return PacketType;
}({});
export class Encoder {
  encode(packet) {
    if (packet.type === PacketType.EVENT || packet.type === PacketType.ACK) {
      const attachments = [];
      extractAttachments(packet.data, attachments);
      if (attachments.length) {
        packet.attachments = attachments.length;
        packet.type = packet.type === PacketType.EVENT ? PacketType.BINARY_EVENT : PacketType.BINARY_ACK;
        return [
          encodeAsString(packet),
          ...attachments
        ];
      }
    }
    return [
      encodeAsString(packet)
    ];
  }
}
function encodeAsString(packet) {
  let output = "" + packet.type;
  if (packet.type === PacketType.BINARY_EVENT || packet.type === PacketType.BINARY_ACK) {
    output += packet.attachments + "-";
  }
  if (packet.nsp !== "/") {
    output += packet.nsp + ",";
  }
  if (packet.id !== undefined) {
    output += packet.id;
  }
  if (packet.data) {
    output += JSON.stringify(packet.data);
  }
  getLogger("socket.io").debug(`[parser] encoded packet as ${output}`);
  return output;
}
/**
 * Extract the binary attachments from the payload
 * @param data
 * @param attachments
 */ function extractAttachments(data, attachments) {
  if (Array.isArray(data)) {
    for(let i = 0; i < data.length; i++){
      const elem = data[i];
      if (isAttachment(elem)) {
        data[i] = {
          _placeholder: true,
          num: attachments.length
        };
        attachments.push(elem);
      } else {
        extractAttachments(data[i], attachments);
      }
    }
  } else if (typeof data === "object" && !(data instanceof Date)) {
    for(const key in data){
      if (Object.prototype.hasOwnProperty.call(data, key)) {
        const elem = data[key];
        if (isAttachment(elem)) {
          data[key] = {
            _placeholder: true,
            num: attachments.length
          };
          attachments.push(elem);
        } else {
          extractAttachments(data[key], attachments);
        }
      }
    }
  }
}
function isAttachment(data) {
  return data instanceof ArrayBuffer || ArrayBuffer.isView(data) || data instanceof Blob;
}
export class Decoder extends EventEmitter {
  buffer;
  add(data) {
    if (typeof data === "string") {
      if (this.buffer) {
        getLogger("socket.io").debug("[parser] got plaintext data while reconstructing a packet");
        this.emitReserved("error");
        return;
      }
      const packet = decodeString(data);
      if (packet === null) {
        this.emitReserved("error");
      } else if (packet.attachments) {
        this.buffer = {
          packet,
          attachments: []
        };
      } else {
        this.emitReserved("packet", packet);
      }
    } else {
      if (!this.buffer) {
        getLogger("socket.io").debug("[parser] got plaintext data while not reconstructing a packet");
        this.emitReserved("error");
        return;
      }
      const { packet, attachments } = this.buffer;
      attachments.push(data);
      if (attachments.length === packet.attachments) {
        injectAttachments(packet.data, attachments);
        this.emitReserved("packet", packet);
        this.buffer = undefined;
      }
    }
  }
  destroy() {
    this.buffer = undefined;
  }
}
function decodeString(str) {
  const packet = {};
  const type = parseInt(str.charAt(0), 10);
  if (PacketType[type] === undefined) {
    getLogger("socket.io").debug(`[parser] unknown packet type: ${type}`);
    return null;
  }
  packet.type = type;
  let i = 0;
  if (type === PacketType.BINARY_EVENT || type === PacketType.BINARY_ACK) {
    const start = i + 1;
    while(str.charAt(++i) !== "-" && i !== str.length){
    // advance cursor
    }
    const attachments = parseInt(str.substring(start, i), 10);
    if (str.charAt(i) !== "-" || !isFinite(attachments) || attachments < 0) {
      getLogger("socket.io").debug(`[parser] illegal attachment count: ${attachments}`);
      return null;
    }
    packet.attachments = attachments;
  }
  if (str.charAt(i + 1) === "/") {
    const start = i + 1;
    while(str.charAt(++i) !== "," && i !== str.length){
    // advance cursor
    }
    packet.nsp = str.substring(start, i);
  } else {
    packet.nsp = "/";
  }
  if (isValidCharCodeForInteger(str.charCodeAt(i + 1))) {
    const start = i + 1;
    while(++i !== str.length){
      if (!isValidCharCodeForInteger(str.charCodeAt(i))) {
        --i;
        break;
      }
    }
    packet.id = parseInt(str.substring(start, i + 1), 10);
  }
  if (str.charAt(++i)) {
    let payload;
    try {
      payload = JSON.parse(str.substr(i));
    } catch (err) {
      getLogger("socket.io").debug(`[parser] invalid payload: ${err}`);
      return null;
    }
    if (!isPayloadValid(type, payload)) {
      getLogger("socket.io").debug(`[parser] invalid payload`);
      return null;
    }
    packet.data = payload;
  }
  return packet;
}
function isValidCharCodeForInteger(code) {
  return code >= 48 && code <= 57;
}
function isPayloadValid(type, payload) {
  switch(type){
    case PacketType.CONNECT:
      return typeof payload === "object";
    case PacketType.DISCONNECT:
      return payload === undefined;
    case PacketType.CONNECT_ERROR:
      return typeof payload === "string" || typeof payload === "object";
    case PacketType.EVENT:
    case PacketType.BINARY_EVENT:
      return Array.isArray(payload) && payload.length > 0;
    case PacketType.ACK:
    case PacketType.BINARY_ACK:
      return Array.isArray(payload);
  }
}
function injectAttachments(data, attachments) {
  if (Array.isArray(data)) {
    for(let i = 0; i < data.length; i++){
      const elem = data[i];
      if (elem && elem._placeholder === true) {
        data[i] = attachments.shift();
      } else {
        injectAttachments(elem, attachments);
      }
    }
  } else if (typeof data === "object" && !(data instanceof Date)) {
    for(const key in data){
      if (Object.prototype.hasOwnProperty.call(data, key)) {
        const elem = data[key];
        if (elem && elem._placeholder === true) {
          data[key] = attachments.shift();
        } else {
          injectAttachments(elem, attachments);
        }
      }
    }
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvc29ja2V0X2lvQDAuMi4xL3BhY2thZ2VzL3NvY2tldC5pby1wYXJzZXIvbW9kLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIGRlbm8tbGludC1pZ25vcmUtZmlsZVxuXG5pbXBvcnQgeyB0eXBlIFJhd0RhdGEgfSBmcm9tIFwiLi4vZW5naW5lLmlvLXBhcnNlci9tb2QudHNcIjtcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCIuLi9ldmVudC1lbWl0dGVyL21vZC50c1wiO1xuaW1wb3J0IHsgZ2V0TG9nZ2VyIH0gZnJvbSBcIi4uLy4uL2RlcHMudHNcIjtcblxuZXhwb3J0IGVudW0gUGFja2V0VHlwZSB7XG4gIENPTk5FQ1QsXG4gIERJU0NPTk5FQ1QsXG4gIEVWRU5ULFxuICBBQ0ssXG4gIENPTk5FQ1RfRVJST1IsXG4gIEJJTkFSWV9FVkVOVCxcbiAgQklOQVJZX0FDSyxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYWNrZXQge1xuICB0eXBlOiBQYWNrZXRUeXBlO1xuICBuc3A6IHN0cmluZztcbiAgZGF0YT86IGFueTtcbiAgaWQ/OiBudW1iZXI7XG4gIGF0dGFjaG1lbnRzPzogbnVtYmVyO1xufVxuXG50eXBlIEF0dGFjaG1lbnRzID0gQXJyYXlCdWZmZXIgfCBBcnJheUJ1ZmZlclZpZXcgfCBCbG9iO1xuXG5leHBvcnQgY2xhc3MgRW5jb2RlciB7XG4gIHB1YmxpYyBlbmNvZGUocGFja2V0OiBQYWNrZXQpOiBSYXdEYXRhW10ge1xuICAgIGlmIChwYWNrZXQudHlwZSA9PT0gUGFja2V0VHlwZS5FVkVOVCB8fCBwYWNrZXQudHlwZSA9PT0gUGFja2V0VHlwZS5BQ0spIHtcbiAgICAgIGNvbnN0IGF0dGFjaG1lbnRzOiBBdHRhY2htZW50c1tdID0gW107XG4gICAgICBleHRyYWN0QXR0YWNobWVudHMocGFja2V0LmRhdGEsIGF0dGFjaG1lbnRzKTtcbiAgICAgIGlmIChhdHRhY2htZW50cy5sZW5ndGgpIHtcbiAgICAgICAgcGFja2V0LmF0dGFjaG1lbnRzID0gYXR0YWNobWVudHMubGVuZ3RoO1xuICAgICAgICBwYWNrZXQudHlwZSA9IHBhY2tldC50eXBlID09PSBQYWNrZXRUeXBlLkVWRU5UXG4gICAgICAgICAgPyBQYWNrZXRUeXBlLkJJTkFSWV9FVkVOVFxuICAgICAgICAgIDogUGFja2V0VHlwZS5CSU5BUllfQUNLO1xuICAgICAgICByZXR1cm4gW2VuY29kZUFzU3RyaW5nKHBhY2tldCksIC4uLmF0dGFjaG1lbnRzXTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFtlbmNvZGVBc1N0cmluZyhwYWNrZXQpXTtcbiAgfVxufVxuXG5mdW5jdGlvbiBlbmNvZGVBc1N0cmluZyhwYWNrZXQ6IFBhY2tldCk6IHN0cmluZyB7XG4gIGxldCBvdXRwdXQgPSBcIlwiICsgcGFja2V0LnR5cGU7XG5cbiAgaWYgKFxuICAgIHBhY2tldC50eXBlID09PSBQYWNrZXRUeXBlLkJJTkFSWV9FVkVOVCB8fFxuICAgIHBhY2tldC50eXBlID09PSBQYWNrZXRUeXBlLkJJTkFSWV9BQ0tcbiAgKSB7XG4gICAgb3V0cHV0ICs9IHBhY2tldC5hdHRhY2htZW50cyArIFwiLVwiO1xuICB9XG5cbiAgaWYgKHBhY2tldC5uc3AgIT09IFwiL1wiKSB7XG4gICAgb3V0cHV0ICs9IHBhY2tldC5uc3AgKyBcIixcIjtcbiAgfVxuXG4gIGlmIChwYWNrZXQuaWQgIT09IHVuZGVmaW5lZCkge1xuICAgIG91dHB1dCArPSBwYWNrZXQuaWQ7XG4gIH1cblxuICBpZiAocGFja2V0LmRhdGEpIHtcbiAgICBvdXRwdXQgKz0gSlNPTi5zdHJpbmdpZnkocGFja2V0LmRhdGEpO1xuICB9XG5cbiAgZ2V0TG9nZ2VyKFwic29ja2V0LmlvXCIpLmRlYnVnKGBbcGFyc2VyXSBlbmNvZGVkIHBhY2tldCBhcyAke291dHB1dH1gKTtcblxuICByZXR1cm4gb3V0cHV0O1xufVxuXG4vKipcbiAqIEV4dHJhY3QgdGhlIGJpbmFyeSBhdHRhY2htZW50cyBmcm9tIHRoZSBwYXlsb2FkXG4gKiBAcGFyYW0gZGF0YVxuICogQHBhcmFtIGF0dGFjaG1lbnRzXG4gKi9cbmZ1bmN0aW9uIGV4dHJhY3RBdHRhY2htZW50cyhkYXRhOiBhbnksIGF0dGFjaG1lbnRzOiBBdHRhY2htZW50c1tdKSB7XG4gIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBlbGVtID0gZGF0YVtpXTtcbiAgICAgIGlmIChpc0F0dGFjaG1lbnQoZWxlbSkpIHtcbiAgICAgICAgZGF0YVtpXSA9IHsgX3BsYWNlaG9sZGVyOiB0cnVlLCBudW06IGF0dGFjaG1lbnRzLmxlbmd0aCB9O1xuICAgICAgICBhdHRhY2htZW50cy5wdXNoKGVsZW0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXh0cmFjdEF0dGFjaG1lbnRzKGRhdGFbaV0sIGF0dGFjaG1lbnRzKTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09IFwib2JqZWN0XCIgJiYgIShkYXRhIGluc3RhbmNlb2YgRGF0ZSkpIHtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBkYXRhKSB7XG4gICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGRhdGEsIGtleSkpIHtcbiAgICAgICAgY29uc3QgZWxlbSA9IGRhdGFba2V5XTtcbiAgICAgICAgaWYgKGlzQXR0YWNobWVudChlbGVtKSkge1xuICAgICAgICAgIGRhdGFba2V5XSA9IHsgX3BsYWNlaG9sZGVyOiB0cnVlLCBudW06IGF0dGFjaG1lbnRzLmxlbmd0aCB9O1xuICAgICAgICAgIGF0dGFjaG1lbnRzLnB1c2goZWxlbSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZXh0cmFjdEF0dGFjaG1lbnRzKGRhdGFba2V5XSwgYXR0YWNobWVudHMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGlzQXR0YWNobWVudChkYXRhOiB1bmtub3duKTogYm9vbGVhbiB7XG4gIHJldHVybiBkYXRhIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgfHwgQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpIHx8XG4gICAgZGF0YSBpbnN0YW5jZW9mIEJsb2I7XG59XG5cbmludGVyZmFjZSBEZWNvZGVyRXZlbnRzIHtcbiAgcGFja2V0OiAocGFja2V0OiBQYWNrZXQpID0+IHZvaWQ7XG4gIGVycm9yOiAoKSA9PiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgRGVjb2RlciBleHRlbmRzIEV2ZW50RW1pdHRlcjxcbiAgUmVjb3JkPG5ldmVyLCBuZXZlcj4sXG4gIFJlY29yZDxuZXZlciwgbmV2ZXI+LFxuICBEZWNvZGVyRXZlbnRzXG4+IHtcbiAgcHJpdmF0ZSBidWZmZXI/OiB7XG4gICAgcGFja2V0OiBQYWNrZXQ7XG4gICAgYXR0YWNobWVudHM6IEF0dGFjaG1lbnRzW107XG4gIH07XG5cbiAgcHVibGljIGFkZChkYXRhOiBSYXdEYXRhKTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiBkYXRhID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBpZiAodGhpcy5idWZmZXIpIHtcbiAgICAgICAgZ2V0TG9nZ2VyKFwic29ja2V0LmlvXCIpLmRlYnVnKFxuICAgICAgICAgIFwiW3BhcnNlcl0gZ290IHBsYWludGV4dCBkYXRhIHdoaWxlIHJlY29uc3RydWN0aW5nIGEgcGFja2V0XCIsXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuZW1pdFJlc2VydmVkKFwiZXJyb3JcIik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcGFja2V0ID0gZGVjb2RlU3RyaW5nKGRhdGEpO1xuXG4gICAgICBpZiAocGFja2V0ID09PSBudWxsKSB7XG4gICAgICAgIHRoaXMuZW1pdFJlc2VydmVkKFwiZXJyb3JcIik7XG4gICAgICB9IGVsc2UgaWYgKHBhY2tldC5hdHRhY2htZW50cykge1xuICAgICAgICB0aGlzLmJ1ZmZlciA9IHtcbiAgICAgICAgICBwYWNrZXQsXG4gICAgICAgICAgYXR0YWNobWVudHM6IFtdLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5lbWl0UmVzZXJ2ZWQoXCJwYWNrZXRcIiwgcGFja2V0KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCF0aGlzLmJ1ZmZlcikge1xuICAgICAgICBnZXRMb2dnZXIoXCJzb2NrZXQuaW9cIikuZGVidWcoXG4gICAgICAgICAgXCJbcGFyc2VyXSBnb3QgcGxhaW50ZXh0IGRhdGEgd2hpbGUgbm90IHJlY29uc3RydWN0aW5nIGEgcGFja2V0XCIsXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuZW1pdFJlc2VydmVkKFwiZXJyb3JcIik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHsgcGFja2V0LCBhdHRhY2htZW50cyB9ID0gdGhpcy5idWZmZXI7XG4gICAgICBhdHRhY2htZW50cy5wdXNoKGRhdGEpO1xuICAgICAgaWYgKGF0dGFjaG1lbnRzLmxlbmd0aCA9PT0gcGFja2V0LmF0dGFjaG1lbnRzKSB7XG4gICAgICAgIGluamVjdEF0dGFjaG1lbnRzKHBhY2tldC5kYXRhLCBhdHRhY2htZW50cyk7XG4gICAgICAgIHRoaXMuZW1pdFJlc2VydmVkKFwicGFja2V0XCIsIHBhY2tldCk7XG4gICAgICAgIHRoaXMuYnVmZmVyID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIHRoaXMuYnVmZmVyID0gdW5kZWZpbmVkO1xuICB9XG59XG5cbmZ1bmN0aW9uIGRlY29kZVN0cmluZyhzdHI6IHN0cmluZyk6IFBhY2tldCB8IG51bGwge1xuICBjb25zdCBwYWNrZXQ6IFBhcnRpYWw8UGFja2V0PiA9IHt9O1xuXG4gIGNvbnN0IHR5cGUgPSBwYXJzZUludChzdHIuY2hhckF0KDApLCAxMCk7XG4gIGlmIChQYWNrZXRUeXBlW3R5cGVdID09PSB1bmRlZmluZWQpIHtcbiAgICBnZXRMb2dnZXIoXCJzb2NrZXQuaW9cIikuZGVidWcoYFtwYXJzZXJdIHVua25vd24gcGFja2V0IHR5cGU6ICR7dHlwZX1gKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBwYWNrZXQudHlwZSA9IHR5cGU7XG5cbiAgbGV0IGkgPSAwO1xuICBpZiAoXG4gICAgdHlwZSA9PT0gUGFja2V0VHlwZS5CSU5BUllfRVZFTlQgfHxcbiAgICB0eXBlID09PSBQYWNrZXRUeXBlLkJJTkFSWV9BQ0tcbiAgKSB7XG4gICAgY29uc3Qgc3RhcnQgPSBpICsgMTtcbiAgICB3aGlsZSAoc3RyLmNoYXJBdCgrK2kpICE9PSBcIi1cIiAmJiBpICE9PSBzdHIubGVuZ3RoKSB7XG4gICAgICAvLyBhZHZhbmNlIGN1cnNvclxuICAgIH1cbiAgICBjb25zdCBhdHRhY2htZW50cyA9IHBhcnNlSW50KHN0ci5zdWJzdHJpbmcoc3RhcnQsIGkpLCAxMCk7XG4gICAgaWYgKHN0ci5jaGFyQXQoaSkgIT09IFwiLVwiIHx8ICFpc0Zpbml0ZShhdHRhY2htZW50cykgfHwgYXR0YWNobWVudHMgPCAwKSB7XG4gICAgICBnZXRMb2dnZXIoXCJzb2NrZXQuaW9cIikuZGVidWcoXG4gICAgICAgIGBbcGFyc2VyXSBpbGxlZ2FsIGF0dGFjaG1lbnQgY291bnQ6ICR7YXR0YWNobWVudHN9YCxcbiAgICAgICk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcGFja2V0LmF0dGFjaG1lbnRzID0gYXR0YWNobWVudHM7XG4gIH1cblxuICBpZiAoc3RyLmNoYXJBdChpICsgMSkgPT09IFwiL1wiKSB7XG4gICAgY29uc3Qgc3RhcnQgPSBpICsgMTtcbiAgICB3aGlsZSAoc3RyLmNoYXJBdCgrK2kpICE9PSBcIixcIiAmJiBpICE9PSBzdHIubGVuZ3RoKSB7XG4gICAgICAvLyBhZHZhbmNlIGN1cnNvclxuICAgIH1cbiAgICBwYWNrZXQubnNwID0gc3RyLnN1YnN0cmluZyhzdGFydCwgaSk7XG4gIH0gZWxzZSB7XG4gICAgcGFja2V0Lm5zcCA9IFwiL1wiO1xuICB9XG5cbiAgaWYgKGlzVmFsaWRDaGFyQ29kZUZvckludGVnZXIoc3RyLmNoYXJDb2RlQXQoaSArIDEpKSkge1xuICAgIGNvbnN0IHN0YXJ0ID0gaSArIDE7XG4gICAgd2hpbGUgKCsraSAhPT0gc3RyLmxlbmd0aCkge1xuICAgICAgaWYgKCFpc1ZhbGlkQ2hhckNvZGVGb3JJbnRlZ2VyKHN0ci5jaGFyQ29kZUF0KGkpKSkge1xuICAgICAgICAtLWk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBwYWNrZXQuaWQgPSBwYXJzZUludChzdHIuc3Vic3RyaW5nKHN0YXJ0LCBpICsgMSksIDEwKTtcbiAgfVxuXG4gIGlmIChzdHIuY2hhckF0KCsraSkpIHtcbiAgICBsZXQgcGF5bG9hZDtcbiAgICB0cnkge1xuICAgICAgcGF5bG9hZCA9IEpTT04ucGFyc2Uoc3RyLnN1YnN0cihpKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBnZXRMb2dnZXIoXCJzb2NrZXQuaW9cIikuZGVidWcoYFtwYXJzZXJdIGludmFsaWQgcGF5bG9hZDogJHtlcnJ9YCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgaWYgKCFpc1BheWxvYWRWYWxpZCh0eXBlLCBwYXlsb2FkKSkge1xuICAgICAgZ2V0TG9nZ2VyKFwic29ja2V0LmlvXCIpLmRlYnVnKGBbcGFyc2VyXSBpbnZhbGlkIHBheWxvYWRgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBwYWNrZXQuZGF0YSA9IHBheWxvYWQ7XG4gIH1cblxuICByZXR1cm4gcGFja2V0IGFzIFBhY2tldDtcbn1cblxuZnVuY3Rpb24gaXNWYWxpZENoYXJDb2RlRm9ySW50ZWdlcihjb2RlOiBudW1iZXIpIHtcbiAgcmV0dXJuIGNvZGUgPj0gNDggJiYgY29kZSA8PSA1Nztcbn1cblxuZnVuY3Rpb24gaXNQYXlsb2FkVmFsaWQodHlwZTogUGFja2V0VHlwZSwgcGF5bG9hZDogdW5rbm93bik6IGJvb2xlYW4ge1xuICBzd2l0Y2ggKHR5cGUpIHtcbiAgICBjYXNlIFBhY2tldFR5cGUuQ09OTkVDVDpcbiAgICAgIHJldHVybiB0eXBlb2YgcGF5bG9hZCA9PT0gXCJvYmplY3RcIjtcbiAgICBjYXNlIFBhY2tldFR5cGUuRElTQ09OTkVDVDpcbiAgICAgIHJldHVybiBwYXlsb2FkID09PSB1bmRlZmluZWQ7XG4gICAgY2FzZSBQYWNrZXRUeXBlLkNPTk5FQ1RfRVJST1I6XG4gICAgICByZXR1cm4gdHlwZW9mIHBheWxvYWQgPT09IFwic3RyaW5nXCIgfHwgdHlwZW9mIHBheWxvYWQgPT09IFwib2JqZWN0XCI7XG4gICAgY2FzZSBQYWNrZXRUeXBlLkVWRU5UOlxuICAgIGNhc2UgUGFja2V0VHlwZS5CSU5BUllfRVZFTlQ6XG4gICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShwYXlsb2FkKSAmJiBwYXlsb2FkLmxlbmd0aCA+IDA7XG4gICAgY2FzZSBQYWNrZXRUeXBlLkFDSzpcbiAgICBjYXNlIFBhY2tldFR5cGUuQklOQVJZX0FDSzpcbiAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHBheWxvYWQpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGluamVjdEF0dGFjaG1lbnRzKGRhdGE6IGFueSwgYXR0YWNobWVudHM6IEF0dGFjaG1lbnRzW10pIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGVsZW0gPSBkYXRhW2ldO1xuICAgICAgaWYgKGVsZW0gJiYgZWxlbS5fcGxhY2Vob2xkZXIgPT09IHRydWUpIHtcbiAgICAgICAgZGF0YVtpXSA9IGF0dGFjaG1lbnRzLnNoaWZ0KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbmplY3RBdHRhY2htZW50cyhlbGVtLCBhdHRhY2htZW50cyk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRhID09PSBcIm9iamVjdFwiICYmICEoZGF0YSBpbnN0YW5jZW9mIERhdGUpKSB7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gZGF0YSkge1xuICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChkYXRhLCBrZXkpKSB7XG4gICAgICAgIGNvbnN0IGVsZW0gPSBkYXRhW2tleV07XG4gICAgICAgIGlmIChlbGVtICYmIGVsZW0uX3BsYWNlaG9sZGVyID09PSB0cnVlKSB7XG4gICAgICAgICAgZGF0YVtrZXldID0gYXR0YWNobWVudHMuc2hpZnQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbmplY3RBdHRhY2htZW50cyhlbGVtLCBhdHRhY2htZW50cyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx3QkFBd0I7QUFHeEIsU0FBUyxZQUFZLFFBQVEsMEJBQTBCO0FBQ3ZELFNBQVMsU0FBUyxRQUFRLGdCQUFnQjtBQUUxQyxPQUFPLElBQUEsQUFBSyxvQ0FBQTs7Ozs7Ozs7U0FBQTtNQVFYO0FBWUQsT0FBTyxNQUFNO0VBQ0osT0FBTyxNQUFjLEVBQWE7SUFDdkMsSUFBSSxPQUFPLElBQUksS0FBSyxXQUFXLEtBQUssSUFBSSxPQUFPLElBQUksS0FBSyxXQUFXLEdBQUcsRUFBRTtNQUN0RSxNQUFNLGNBQTZCLEVBQUU7TUFDckMsbUJBQW1CLE9BQU8sSUFBSSxFQUFFO01BQ2hDLElBQUksWUFBWSxNQUFNLEVBQUU7UUFDdEIsT0FBTyxXQUFXLEdBQUcsWUFBWSxNQUFNO1FBQ3ZDLE9BQU8sSUFBSSxHQUFHLE9BQU8sSUFBSSxLQUFLLFdBQVcsS0FBSyxHQUMxQyxXQUFXLFlBQVksR0FDdkIsV0FBVyxVQUFVO1FBQ3pCLE9BQU87VUFBQyxlQUFlO2FBQVk7U0FBWTtNQUNqRDtJQUNGO0lBQ0EsT0FBTztNQUFDLGVBQWU7S0FBUTtFQUNqQztBQUNGO0FBRUEsU0FBUyxlQUFl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
// denoCacheMetadata=6262377988389906316,916577783405729841