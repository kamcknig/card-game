import { okReply, sendCommands } from "./protocol/mod.ts";
import { create } from "./redis.ts";
import { deferred } from "./vendor/https/deno.land/std/async/deferred.ts";
export function createRedisPipeline(connection, tx = false) {
  const executor = new PipelineExecutor(connection, tx);
  function flush() {
    return executor.flush();
  }
  const client = create(executor);
  return Object.assign(client, {
    flush
  });
}
export class PipelineExecutor {
  connection;
  tx;
  commands;
  queue;
  constructor(connection, tx){
    this.connection = connection;
    this.tx = tx;
    this.commands = [];
    this.queue = [];
  }
  exec(command, ...args) {
    this.commands.push({
      command,
      args
    });
    return Promise.resolve(okReply);
  }
  close() {
    return this.connection.close();
  }
  flush() {
    if (this.tx) {
      this.commands.unshift({
        command: "MULTI",
        args: []
      });
      this.commands.push({
        command: "EXEC",
        args: []
      });
    }
    const d = deferred();
    this.queue.push({
      commands: [
        ...this.commands
      ],
      d
    });
    if (this.queue.length === 1) {
      this.dequeue();
    }
    this.commands = [];
    return d;
  }
  dequeue() {
    const [e] = this.queue;
    if (!e) return;
    sendCommands(this.connection.writer, this.connection.reader, e.commands).then(e.d.resolve).catch(e.d.reject).finally(()=>{
      this.queue.shift();
      this.dequeue();
    });
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvc29ja2V0X2lvQDAuMi4xL3ZlbmRvci9kZW5vLmxhbmQveC9yZWRpc0B2MC4yNy4xL3BpcGVsaW5lLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29ubmVjdGlvbiB9IGZyb20gXCIuL2Nvbm5lY3Rpb24udHNcIjtcbmltcG9ydCB7IENvbW1hbmRFeGVjdXRvciB9IGZyb20gXCIuL2V4ZWN1dG9yLnRzXCI7XG5pbXBvcnQge1xuICBva1JlcGx5LFxuICBSYXdPckVycm9yLFxuICBSZWRpc1JlcGx5LFxuICBSZWRpc1ZhbHVlLFxuICBzZW5kQ29tbWFuZHMsXG59IGZyb20gXCIuL3Byb3RvY29sL21vZC50c1wiO1xuaW1wb3J0IHsgY3JlYXRlLCBSZWRpcyB9IGZyb20gXCIuL3JlZGlzLnRzXCI7XG5pbXBvcnQge1xuICBEZWZlcnJlZCxcbiAgZGVmZXJyZWQsXG59IGZyb20gXCIuL3ZlbmRvci9odHRwcy9kZW5vLmxhbmQvc3RkL2FzeW5jL2RlZmVycmVkLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVkaXNQaXBlbGluZSBleHRlbmRzIFJlZGlzIHtcbiAgZmx1c2goKTogUHJvbWlzZTxSYXdPckVycm9yW10+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmVkaXNQaXBlbGluZShcbiAgY29ubmVjdGlvbjogQ29ubmVjdGlvbixcbiAgdHggPSBmYWxzZSxcbik6IFJlZGlzUGlwZWxpbmUge1xuICBjb25zdCBleGVjdXRvciA9IG5ldyBQaXBlbGluZUV4ZWN1dG9yKGNvbm5lY3Rpb24sIHR4KTtcbiAgZnVuY3Rpb24gZmx1c2goKTogUHJvbWlzZTxSYXdPckVycm9yW10+IHtcbiAgICByZXR1cm4gZXhlY3V0b3IuZmx1c2goKTtcbiAgfVxuICBjb25zdCBjbGllbnQgPSBjcmVhdGUoZXhlY3V0b3IpO1xuICByZXR1cm4gT2JqZWN0LmFzc2lnbihjbGllbnQsIHsgZmx1c2ggfSk7XG59XG5cbmV4cG9ydCBjbGFzcyBQaXBlbGluZUV4ZWN1dG9yIGltcGxlbWVudHMgQ29tbWFuZEV4ZWN1dG9yIHtcbiAgcHJpdmF0ZSBjb21tYW5kczoge1xuICAgIGNvbW1hbmQ6IHN0cmluZztcbiAgICBhcmdzOiBSZWRpc1ZhbHVlW107XG4gIH1bXSA9IFtdO1xuICBwcml2YXRlIHF1ZXVlOiB7XG4gICAgY29tbWFuZHM6IHtcbiAgICAgIGNvbW1hbmQ6IHN0cmluZztcbiAgICAgIGFyZ3M6IFJlZGlzVmFsdWVbXTtcbiAgICB9W107XG4gICAgZDogRGVmZXJyZWQ8UmF3T3JFcnJvcltdPjtcbiAgfVtdID0gW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgY29ubmVjdGlvbjogQ29ubmVjdGlvbixcbiAgICBwcml2YXRlIHR4OiBib29sZWFuLFxuICApIHtcbiAgfVxuXG4gIGV4ZWMoXG4gICAgY29tbWFuZDogc3RyaW5nLFxuICAgIC4uLmFyZ3M6IFJlZGlzVmFsdWVbXVxuICApOiBQcm9taXNlPFJlZGlzUmVwbHk+IHtcbiAgICB0aGlzLmNvbW1hbmRzLnB1c2goeyBjb21tYW5kLCBhcmdzIH0pO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUob2tSZXBseSk7XG4gIH1cblxuICBjbG9zZSgpOiB2b2lkIHtcbiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uLmNsb3NlKCk7XG4gIH1cblxuICBmbHVzaCgpOiBQcm9taXNlPFJhd09yRXJyb3JbXT4ge1xuICAgIGlmICh0aGlzLnR4KSB7XG4gICAgICB0aGlzLmNvbW1hbmRzLnVuc2hpZnQoeyBjb21tYW5kOiBcIk1VTFRJXCIsIGFyZ3M6IFtdIH0pO1xuICAgICAgdGhpcy5jb21tYW5kcy5wdXNoKHsgY29tbWFuZDogXCJFWEVDXCIsIGFyZ3M6IFtdIH0pO1xuICAgIH1cbiAgICBjb25zdCBkID0gZGVmZXJyZWQ8UmF3T3JFcnJvcltdPigpO1xuICAgIHRoaXMucXVldWUucHVzaCh7IGNvbW1hbmRzOiBbLi4udGhpcy5jb21tYW5kc10sIGQgfSk7XG4gICAgaWYgKHRoaXMucXVldWUubGVuZ3RoID09PSAxKSB7XG4gICAgICB0aGlzLmRlcXVldWUoKTtcbiAgICB9XG4gICAgdGhpcy5jb21tYW5kcyA9IFtdO1xuICAgIHJldHVybiBkO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXF1ZXVlKCk6IHZvaWQge1xuICAgIGNvbnN0IFtlXSA9IHRoaXMucXVldWU7XG4gICAgaWYgKCFlKSByZXR1cm47XG4gICAgc2VuZENvbW1hbmRzKHRoaXMuY29ubmVjdGlvbi53cml0ZXIsIHRoaXMuY29ubmVjdGlvbi5yZWFkZXIsIGUuY29tbWFuZHMpXG4gICAgICAudGhlbihlLmQucmVzb2x2ZSlcbiAgICAgIC5jYXRjaChlLmQucmVqZWN0KVxuICAgICAgLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICB0aGlzLnF1ZXVlLnNoaWZ0KCk7XG4gICAgICAgIHRoaXMuZGVxdWV1ZSgpO1xuICAgICAgfSk7XG4gIH1cbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxTQUNFLE9BQU8sRUFJUCxZQUFZLFFBQ1Asb0JBQW9CO0FBQzNCLFNBQVMsTUFBTSxRQUFlLGFBQWE7QUFDM0MsU0FFRSxRQUFRLFFBQ0gsaURBQWlEO0FBTXhELE9BQU8sU0FBUyxvQkFDZCxVQUFzQixFQUN0QixLQUFLLEtBQUs7RUFFVixNQUFNLFdBQVcsSUFBSSxpQkFBaUIsWUFBWTtFQUNsRCxTQUFTO0lBQ1AsT0FBTyxTQUFTLEtBQUs7RUFDdkI7RUFDQSxNQUFNLFNBQVMsT0FBTztFQUN0QixPQUFPLE9BQU8sTUFBTSxDQUFDLFFBQVE7SUFBRTtFQUFNO0FBQ3ZDO0FBRUEsT0FBTyxNQUFNOzs7RUFDSCxTQUdDO0VBQ0QsTUFNQztFQUVULFlBQ0UsQUFBUyxVQUFzQixFQUMvQixBQUFRLEVBQVcsQ0FDbkI7U0FGUyxhQUFBO1NBQ0QsS0FBQTtTQWRGLFdBR0YsRUFBRTtTQUNBLFFBTUYsRUFBRTtFQU1SO0VBRUEsS0FDRSxPQUFlLEVBQ2YsR0FBRyxJQUFrQixFQUNBO0lBQ3JCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO01BQUU7TUFBUztJQUFLO0lBQ25DLE9BQU8sUUFBUSxPQUFPLENBQUM7RUFDekI7RUFFQSxRQUFjO0lBQ1osT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUs7RUFDOUI7RUFFQSxRQUErQjtJQUM3QixJQUFJLElBQUksQ0FBQyxFQUFFLEVBQUU7TUFDWCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztRQUFFLFNBQVM7UUFBUyxNQUFNLEVBQUU7TUFBQztNQUNuRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUFFLFNBQVM7UUFBUSxNQUFNLEVBQUU7TUFBQztJQUNqRDtJQUNBLE1BQU0sSUFBSTtJQUNWLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO01BQUUsVUFBVTtXQUFJLElBQUksQ0FBQyxRQUFRO09BQUM7TUFBRTtJQUFFO0lBQ2xELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEtBQUssR0FBRztNQUMzQixJQUFJLENBQUMsT0FBTztJQUNkO0lBQ0EsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFO0lBQ2xCLE9BQU87RUFDVDtFQUVRLFVBQWdCO0lBQ3RCLE1BQU0sQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUs7SUFDdEIsSUFBSSxDQUFDLEdBQUc7SUFDUixhQUFhLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLEVBQUUsUUFBUSxFQUNwRSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUNoQixLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUNoQixPQUFPLENBQUM7TUFDUCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUs7TUFDaEIsSUFBSSxDQUFDLE9BQU87SUFDZDtFQUNKO0FBQ0YifQ==
// denoCacheMetadata=3429215153678908160,5885131220507435803