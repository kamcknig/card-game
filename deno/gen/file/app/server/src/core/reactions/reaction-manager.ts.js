import { CardLike } from 'shared/shared-types.ts';
import { Reaction } from '../../types.ts';
import { getOrderStartingFrom } from '../../utils/get-order-starting-from.ts';
import { groupReactionsByCardKey } from './group-reactions-by-card-key.ts';
import { buildActionButtons } from './build-action-buttons.ts';
import { buildActionMap } from './build-action-map.ts';
import { cardLifecycleMap } from '../card-lifecycle-map.ts';
export class ReactionManager {
  _cardSourceController;
  _findCards;
  cardPriceController;
  logManager;
  _match;
  _cardLibrary;
  runGameActionDelegate;
  _reactions;
  _expansionGameEventHandlers;
  constructor(_cardSourceController, _findCards, cardPriceController, logManager, _match, _cardLibrary, runGameActionDelegate){
    this._cardSourceController = _cardSourceController;
    this._findCards = _findCards;
    this.cardPriceController = cardPriceController;
    this.logManager = logManager;
    this._match = _match;
    this._cardLibrary = _cardLibrary;
    this.runGameActionDelegate = runGameActionDelegate;
    this._reactions = [];
    this._expansionGameEventHandlers = {};
  }
  endGame() {}
  registerGameEvent(event, handler) {
    this._expansionGameEventHandlers[event] ??= [];
    this._expansionGameEventHandlers[event].push(handler);
  }
  async getReactions(trigger, reactionSet) {
    const reactions = reactionSet ?? this._reactions;
    const finalReactions = [];
    for (const reaction of reactions){
      if (reaction.listeningFor !== trigger.eventType) continue;
      console.log(`[REACTION MANAGER] checking trigger ${trigger} condition for ${reaction.id} reaction`);
      let include = true;
      if (reaction.condition !== undefined) {
        const result = await reaction.condition({
          cardSourceController: this._cardSourceController,
          cardPriceController: this.cardPriceController,
          reactionManager: this,
          runGameActionDelegate: this.runGameActionDelegate,
          findCards: this._findCards,
          match: this._match,
          cardLibrary: this._cardLibrary,
          trigger,
          reaction
        });
        include = result;
      }
      if (include) {
        finalReactions.push(reaction);
      }
    }
    return finalReactions;
  }
  async getReactionsForPlayer(trigger, playerId) {
    const playerReactions = this._reactions.filter((reaction)=>reaction.playerId === playerId);
    return await this.getReactions(trigger, playerReactions);
  }
  unregisterTrigger(triggerId) {
    for(let i = this._reactions.length - 1; i >= 0; i--){
      const trigger = this._reactions[i];
      if (trigger.id === triggerId) {
        this._reactions.splice(i, 1);
        console.log(`[REACTION MANAGER] removing trigger reaction ${triggerId} for player ${this._match.players?.find((player)=>player.id === trigger.playerId)}`);
      }
    }
  }
  registerSystemTemplate(cardLike, event, reactionTemplate) {
    const systemTemplate = {
      ...reactionTemplate,
      id: `${cardLike.cardKey}:${cardLike.id}:${event}:system`,
      system: true
    };
    this.registerReactionTemplate(cardLike, event, systemTemplate);
  }
  registerReactionTemplate(cardLikeOrTemplate, event, reactionTemplate) {
    let template;
    if (!(cardLikeOrTemplate instanceof CardLike)) {
      template = cardLikeOrTemplate;
    } else {
      template = {
        ...reactionTemplate,
        listeningFor: event,
        id: reactionTemplate && 'id' in reactionTemplate ? reactionTemplate.id : `${cardLikeOrTemplate.cardName}:${cardLikeOrTemplate}:${event}`
      };
    }
    console.log(`[REACTION MANAGER] registering trigger template ID ${template.id}, for player ${template.playerId}`);
    this._reactions.push(new Reaction(template));
  }
  async runGameLifecycleEvent(trigger, ...args) {
    for (const handler of this._expansionGameEventHandlers[trigger] ?? []){
      await handler({
        cardSourceController: this._cardSourceController,
        findCards: this._findCards,
        cardPriceController: this.cardPriceController,
        cardLibrary: this._cardLibrary,
        match: this._match,
        reactionManager: this,
        runGameActionDelegate: this.runGameActionDelegate
      }, ...args);
    }
  }
  async runCardLifecycleEvent(trigger, args) {
    const card = this._cardLibrary.getCard(args.cardId);
    const fn = cardLifecycleMap[card.cardKey]?.[trigger];
    if (!fn) {
      return;
    }
    console.log(`[REACTION MANAGER] running lifecycle trigger '${trigger}' for card ${card}`);
    await fn({
      cardSourceController: this._cardSourceController,
      runGameActionDelegate: this.runGameActionDelegate,
      cardPriceController: this.cardPriceController,
      cardLibrary: this._cardLibrary,
      match: this._match,
      reactionManager: this,
      findCards: this._findCards
    }, args);
  }
  async runTrigger({ trigger, reactionContext }) {
    reactionContext ??= {};
    // now we get the order of players that could be affected by the play (including the current player),
    // then get reactions for them and run them
    const targetOrder = getOrderStartingFrom(this._match.players, this._match.currentPlayerTurnIndex);
    for (const targetPlayer of targetOrder){
      console.log(`[REACTION MANAGER] checking '${trigger.eventType}' reactions for ${targetPlayer}`);
      const usedReactionIds = new Set();
      const blockedCardKeys = new Set();
      while(true){
        const reactions = (await this.getReactionsForPlayer(trigger, targetPlayer.id)).filter((r)=>{
          const key = r.getSourceKey();
          return !usedReactionIds.has(r.id) && !blockedCardKeys.has(key);
        });
        console.log(`[REACTION MANAGER] ${targetPlayer} has ${reactions.length} remaining reactions`);
        if (!reactions.length) break;
        const compulsoryReactions = reactions.filter((r)=>r.compulsory && !r.system);
        const systemReactions = reactions.filter((r)=>r.system);
        if (systemReactions.length) {
          for (const systemReaction of systemReactions){
            console.log(`[REACTION MANAGER] running system reaction ${systemReaction.id} for ${targetPlayer}`);
            await this.runReaction(systemReaction, trigger, targetPlayer, reactionContext);
          }
          continue;
        }
        let selectedReaction = undefined;
        const shouldPrompt = reactions.length > 1 && (compulsoryReactions.length !== reactions.length || // mix of compulsory + optional
        !compulsoryReactions.every((r)=>r.getSourceKey() === compulsoryReactions[0].getSourceKey()) // different
        );
        // when multiple reactions can occur, the user chooses unless they are all compulsory
        // and the same card
        if (shouldPrompt || reactions.length === 1 && compulsoryReactions.length === 0) {
          const grouped = groupReactionsByCardKey(reactions);
          const actionButtons = buildActionButtons(grouped, this._cardLibrary);
          const actionMap = buildActionMap(grouped);
          console.log(`[REACTION MANAGER] prompting ${targetPlayer} to choose reaction`);
          const result = await this.runGameActionDelegate('userPrompt', {
            playerId: targetPlayer.id,
            actionButtons,
            prompt: 'Choose reaction?'
          });
          if (result.action === 0) {
            console.log(`[REACTION MANAGER] ${targetPlayer} chose not to react`);
            break;
          } else {
            console.log(`[REACTION MANAGER] ${targetPlayer} reacts with ${actionMap.get(result.action)}`);
          }
          selectedReaction = actionMap.get(result.action);
        } else {
          selectedReaction = compulsoryReactions[0];
        }
        if (!selectedReaction) {
          console.warn(`[REACTION MANAGER] reaction not found in action map`);
          continue;
        }
        await this.runReaction(selectedReaction, trigger, targetPlayer, {
          cardSourceController: this._cardSourceController,
          findCards: this._findCards,
          reactionManager: this,
          cardPriceController: this.cardPriceController,
          isRootLog: false,
          runGameActionDelegate: this.runGameActionDelegate,
          trigger,
          cardLibrary: this._cardLibrary,
          match: this._match,
          reaction: selectedReaction
        }, reactionContext);
        usedReactionIds.add(selectedReaction.id);
        if (!selectedReaction.allowMultipleInstances) {
          blockedCardKeys.add(selectedReaction.getSourceKey());
        }
      }
    }
  }
  async runReaction(reaction, trigger, targetPlayer, context, reactionContext) {
    const reactionResult = await reaction.triggeredEffectFn({
      cardSourceController: this._cardSourceController,
      findCards: this._findCards,
      reactionManager: this,
      cardPriceController: this.cardPriceController,
      isRootLog: false,
      runGameActionDelegate: this.runGameActionDelegate,
      trigger,
      cardLibrary: this._cardLibrary,
      match: this._match,
      reaction
    });
    // right now the only card that created that has a reaction that the
    // card triggering it needs to know about is moat giving immunity.
    // every other reaction just returns undefined. so if the reaction
    // doesn't give a result, don't set it on the context. this might
    // have to expand later.
    if (reactionResult !== undefined) {
      reactionContext[targetPlayer.id] = {
        reaction,
        trigger,
        result: reactionResult
      };
    }
    if (reaction.once) {
      console.log(`[REACTION MANAGER] selected reaction is single-use, unregistering it`);
      this.unregisterTrigger(reaction.id);
    }
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vYXBwL3NlcnZlci9zcmMvY29yZS9yZWFjdGlvbnMvcmVhY3Rpb24tbWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYXJkSWQsIENhcmRMaWtlLCBNYXRjaCwgUGxheWVyIH0gZnJvbSAnc2hhcmVkL3NoYXJlZC10eXBlcy50cyc7XG5pbXBvcnQge1xuICBDYXJkTGlmZWN5Y2xlRXZlbnQsXG4gIENhcmRMaWZlY3ljbGVFdmVudEFyZ01hcCxcbiAgRmluZENhcmRzRm4sXG4gIEdhbWVMaWZlY3ljbGVDYWxsYmFjayxcbiAgR2FtZUxpZmVjeWNsZUV2ZW50LFxuICBHYW1lTGlmZUN5Y2xlRXZlbnRBcmdzTWFwLFxuICBSZWFjdGlvbixcbiAgUmVhY3Rpb25UZW1wbGF0ZSxcbiAgUmVhY3Rpb25UcmlnZ2VyLFxuICBSdW5HYW1lQWN0aW9uRGVsZWdhdGUsIFRyaWdnZXJlZEVmZmVjdENvbnRleHQsXG4gIFRyaWdnZXJFdmVudFR5cGVcbn0gZnJvbSAnLi4vLi4vdHlwZXMudHMnO1xuaW1wb3J0IHsgTWF0Y2hDYXJkTGlicmFyeSB9IGZyb20gJy4uL21hdGNoLWNhcmQtbGlicmFyeS50cyc7XG5pbXBvcnQgeyBnZXRPcmRlclN0YXJ0aW5nRnJvbSB9IGZyb20gJy4uLy4uL3V0aWxzL2dldC1vcmRlci1zdGFydGluZy1mcm9tLnRzJztcbmltcG9ydCB7IGdyb3VwUmVhY3Rpb25zQnlDYXJkS2V5IH0gZnJvbSAnLi9ncm91cC1yZWFjdGlvbnMtYnktY2FyZC1rZXkudHMnO1xuaW1wb3J0IHsgYnVpbGRBY3Rpb25CdXR0b25zIH0gZnJvbSAnLi9idWlsZC1hY3Rpb24tYnV0dG9ucy50cyc7XG5pbXBvcnQgeyBidWlsZEFjdGlvbk1hcCB9IGZyb20gJy4vYnVpbGQtYWN0aW9uLW1hcC50cyc7XG5pbXBvcnQgeyBjYXJkTGlmZWN5Y2xlTWFwIH0gZnJvbSAnLi4vY2FyZC1saWZlY3ljbGUtbWFwLnRzJztcbmltcG9ydCB7IExvZ01hbmFnZXIgfSBmcm9tICcuLi9sb2ctbWFuYWdlci50cyc7XG5pbXBvcnQgeyBDYXJkUHJpY2VSdWxlc0NvbnRyb2xsZXIgfSBmcm9tICcuLi9jYXJkLXByaWNlLXJ1bGVzLWNvbnRyb2xsZXIudHMnO1xuaW1wb3J0IHsgQ2FyZFNvdXJjZUNvbnRyb2xsZXIgfSBmcm9tICcuLi9jYXJkLXNvdXJjZS1jb250cm9sbGVyLnRzJztcblxuZXhwb3J0IGNsYXNzIFJlYWN0aW9uTWFuYWdlciB7XG4gIHByaXZhdGUgX3JlYWN0aW9uczogUmVhY3Rpb25bXSA9IFtdO1xuICBwcml2YXRlIF9leHBhbnNpb25HYW1lRXZlbnRIYW5kbGVyczogUmVjb3JkPEdhbWVMaWZlY3ljbGVFdmVudCwgR2FtZUxpZmVjeWNsZUNhbGxiYWNrW10+ID0ge30gYXMgUmVjb3JkPEdhbWVMaWZlY3ljbGVFdmVudCwgR2FtZUxpZmVjeWNsZUNhbGxiYWNrW10+XG4gIFxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9jYXJkU291cmNlQ29udHJvbGxlcjogQ2FyZFNvdXJjZUNvbnRyb2xsZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBfZmluZENhcmRzOiBGaW5kQ2FyZHNGbixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhcmRQcmljZUNvbnRyb2xsZXI6IENhcmRQcmljZVJ1bGVzQ29udHJvbGxlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxvZ01hbmFnZXI6IExvZ01hbmFnZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBfbWF0Y2g6IE1hdGNoLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2NhcmRMaWJyYXJ5OiBNYXRjaENhcmRMaWJyYXJ5LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcnVuR2FtZUFjdGlvbkRlbGVnYXRlOiBSdW5HYW1lQWN0aW9uRGVsZWdhdGVcbiAgKSB7XG4gIH1cbiAgXG4gIHB1YmxpYyBlbmRHYW1lKCkge1xuICB9XG4gIFxuICByZWdpc3RlckdhbWVFdmVudChldmVudDogR2FtZUxpZmVjeWNsZUV2ZW50LCBoYW5kbGVyOiBHYW1lTGlmZWN5Y2xlQ2FsbGJhY2spIHtcbiAgICB0aGlzLl9leHBhbnNpb25HYW1lRXZlbnRIYW5kbGVyc1tldmVudF0gPz89IFtdO1xuICAgIHRoaXMuX2V4cGFuc2lvbkdhbWVFdmVudEhhbmRsZXJzW2V2ZW50XS5wdXNoKGhhbmRsZXIpO1xuICB9XG4gIFxuICBhc3luYyBnZXRSZWFjdGlvbnModHJpZ2dlcjogUmVhY3Rpb25UcmlnZ2VyLCByZWFjdGlvblNldD86IFJlYWN0aW9uW10pIHtcbiAgICBjb25zdCByZWFjdGlvbnMgPSByZWFjdGlvblNldCA/PyB0aGlzLl9yZWFjdGlvbnM7XG4gICAgY29uc3QgZmluYWxSZWFjdGlvbnM6IFJlYWN0aW9uW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHJlYWN0aW9uIG9mIHJlYWN0aW9ucykge1xuICAgICAgaWYgKHJlYWN0aW9uLmxpc3RlbmluZ0ZvciAhPT0gdHJpZ2dlci5ldmVudFR5cGUpIGNvbnRpbnVlO1xuICAgICAgXG4gICAgICBjb25zb2xlLmxvZyhgW1JFQUNUSU9OIE1BTkFHRVJdIGNoZWNraW5nIHRyaWdnZXIgJHt0cmlnZ2VyfSBjb25kaXRpb24gZm9yICR7cmVhY3Rpb24uaWR9IHJlYWN0aW9uYCk7XG4gICAgICBcbiAgICAgIGxldCBpbmNsdWRlID0gdHJ1ZTtcbiAgICAgIFxuICAgICAgaWYgKHJlYWN0aW9uLmNvbmRpdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlYWN0aW9uLmNvbmRpdGlvbih7XG4gICAgICAgICAgY2FyZFNvdXJjZUNvbnRyb2xsZXI6IHRoaXMuX2NhcmRTb3VyY2VDb250cm9sbGVyLFxuICAgICAgICAgIGNhcmRQcmljZUNvbnRyb2xsZXI6IHRoaXMuY2FyZFByaWNlQ29udHJvbGxlcixcbiAgICAgICAgICByZWFjdGlvbk1hbmFnZXI6IHRoaXMsXG4gICAgICAgICAgcnVuR2FtZUFjdGlvbkRlbGVnYXRlOiB0aGlzLnJ1bkdhbWVBY3Rpb25EZWxlZ2F0ZSxcbiAgICAgICAgICBmaW5kQ2FyZHM6IHRoaXMuX2ZpbmRDYXJkcyxcbiAgICAgICAgICBtYXRjaDogdGhpcy5fbWF0Y2gsXG4gICAgICAgICAgY2FyZExpYnJhcnk6XG4gICAgICAgICAgdGhpcy5fY2FyZExpYnJhcnksXG4gICAgICAgICAgdHJpZ2dlcixcbiAgICAgICAgICByZWFjdGlvblxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGluY2x1ZGUgPSByZXN1bHQ7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGlmIChpbmNsdWRlKSB7XG4gICAgICAgIGZpbmFsUmVhY3Rpb25zLnB1c2gocmVhY3Rpb24pO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gZmluYWxSZWFjdGlvbnM7XG4gIH1cbiAgXG4gIGFzeW5jIGdldFJlYWN0aW9uc0ZvclBsYXllcih0cmlnZ2VyOiBSZWFjdGlvblRyaWdnZXIsIHBsYXllcklkOiBudW1iZXIpIHtcbiAgICBjb25zdCBwbGF5ZXJSZWFjdGlvbnMgPSB0aGlzLl9yZWFjdGlvbnMuZmlsdGVyKHJlYWN0aW9uID0+IHJlYWN0aW9uLnBsYXllcklkID09PSBwbGF5ZXJJZCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0UmVhY3Rpb25zKHRyaWdnZXIsIHBsYXllclJlYWN0aW9ucyk7XG4gIH1cbiAgXG4gIHVucmVnaXN0ZXJUcmlnZ2VyKHRyaWdnZXJJZDogc3RyaW5nKSB7XG4gICAgZm9yIChsZXQgaSA9IHRoaXMuX3JlYWN0aW9ucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgY29uc3QgdHJpZ2dlciA9IHRoaXMuX3JlYWN0aW9uc1tpXTtcbiAgICAgIGlmICh0cmlnZ2VyLmlkID09PSB0cmlnZ2VySWQpIHtcbiAgICAgICAgdGhpcy5fcmVhY3Rpb25zLnNwbGljZShpLCAxKTtcbiAgICAgICAgY29uc29sZS5sb2coYFtSRUFDVElPTiBNQU5BR0VSXSByZW1vdmluZyB0cmlnZ2VyIHJlYWN0aW9uICR7dHJpZ2dlcklkfSBmb3IgcGxheWVyICR7dGhpcy5fbWF0Y2gucGxheWVycz8uZmluZCgocGxheWVyKSA9PiBwbGF5ZXIuaWQgPT09IHRyaWdnZXIucGxheWVySWQpfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBcbiAgcmVnaXN0ZXJTeXN0ZW1UZW1wbGF0ZTxUIGV4dGVuZHMgVHJpZ2dlckV2ZW50VHlwZT4oY2FyZExpa2U6IENhcmRMaWtlLCBldmVudDogVCwgcmVhY3Rpb25UZW1wbGF0ZTogT21pdDxSZWFjdGlvblRlbXBsYXRlPFQ+LCAnaWQnIHwgJ2xpc3RlbmluZ0Zvcic+KTogdm9pZCB7XG4gICAgY29uc3Qgc3lzdGVtVGVtcGxhdGUgPSB7XG4gICAgICAuLi5yZWFjdGlvblRlbXBsYXRlLFxuICAgICAgaWQ6IGAke2NhcmRMaWtlLmNhcmRLZXl9OiR7Y2FyZExpa2UuaWR9OiR7ZXZlbnR9OnN5c3RlbWAsXG4gICAgICBzeXN0ZW06IHRydWVcbiAgICB9XG4gICAgXG4gICAgdGhpcy5yZWdpc3RlclJlYWN0aW9uVGVtcGxhdGUoY2FyZExpa2UsIGV2ZW50LCBzeXN0ZW1UZW1wbGF0ZSk7XG4gIH1cbiAgXG4gIHJlZ2lzdGVyUmVhY3Rpb25UZW1wbGF0ZTxUIGV4dGVuZHMgVHJpZ2dlckV2ZW50VHlwZT4oY2FyZExpa2U6IENhcmRMaWtlLCBldmVudDogVCwgcmVhY3Rpb25UZW1wbGF0ZTogT21pdDxSZWFjdGlvblRlbXBsYXRlPFQ+LCAnaWQnIHwgJ2xpc3RlbmluZ0ZvcicgfCAnc3lzdGVtJz4pOiB2b2lkXG4gIHJlZ2lzdGVyUmVhY3Rpb25UZW1wbGF0ZTxUIGV4dGVuZHMgVHJpZ2dlckV2ZW50VHlwZT4ocmVhY3Rpb25UZW1wbGF0ZTogUmVhY3Rpb25UZW1wbGF0ZTxUPik6IHZvaWRcbiAgcmVnaXN0ZXJSZWFjdGlvblRlbXBsYXRlPFQgZXh0ZW5kcyBUcmlnZ2VyRXZlbnRUeXBlPihjYXJkTGlrZU9yVGVtcGxhdGU6IENhcmRMaWtlIHwgUmVhY3Rpb25UZW1wbGF0ZTxUPiwgZXZlbnQ/OiBULCByZWFjdGlvblRlbXBsYXRlPzogT21pdDxSZWFjdGlvblRlbXBsYXRlPFQ+LCAnaWQnIHwgJ2xpc3RlbmluZ0ZvcicgfCAnc3lzdGVtJz4pIHtcbiAgICBsZXQgdGVtcGxhdGU6IFJlYWN0aW9uVGVtcGxhdGU8VD47XG4gICAgXG4gICAgaWYgKCEoY2FyZExpa2VPclRlbXBsYXRlIGluc3RhbmNlb2YgQ2FyZExpa2UpKSB7XG4gICAgICB0ZW1wbGF0ZSA9IGNhcmRMaWtlT3JUZW1wbGF0ZTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0ZW1wbGF0ZSA9IHtcbiAgICAgICAgLi4ucmVhY3Rpb25UZW1wbGF0ZSxcbiAgICAgICAgbGlzdGVuaW5nRm9yOiBldmVudCxcbiAgICAgICAgaWQ6IHJlYWN0aW9uVGVtcGxhdGUgJiYgJ2lkJyBpbiByZWFjdGlvblRlbXBsYXRlID8gcmVhY3Rpb25UZW1wbGF0ZS5pZCA6IGAke2NhcmRMaWtlT3JUZW1wbGF0ZS5jYXJkTmFtZX06JHtjYXJkTGlrZU9yVGVtcGxhdGV9OiR7ZXZlbnR9YFxuICAgICAgfSBhcyBSZWFjdGlvblRlbXBsYXRlPFQ+O1xuICAgIH1cbiAgICBcbiAgICBjb25zb2xlLmxvZyhgW1JFQUNUSU9OIE1BTkFHRVJdIHJlZ2lzdGVyaW5nIHRyaWdnZXIgdGVtcGxhdGUgSUQgJHt0ZW1wbGF0ZS5pZH0sIGZvciBwbGF5ZXIgJHt0ZW1wbGF0ZS5wbGF5ZXJJZH1gKTtcbiAgICBcbiAgICB0aGlzLl9yZWFjdGlvbnMucHVzaChuZXcgUmVhY3Rpb24odGVtcGxhdGUpIGFzIGFueSk7XG4gIH1cbiAgXG4gIGFzeW5jIHJ1bkdhbWVMaWZlY3ljbGVFdmVudDxUIGV4dGVuZHMgR2FtZUxpZmVjeWNsZUV2ZW50Pih0cmlnZ2VyOiBULCAuLi5hcmdzOiBHYW1lTGlmZUN5Y2xlRXZlbnRBcmdzTWFwW1RdIGV4dGVuZHMgdm9pZCA/IFtdIDogW0dhbWVMaWZlQ3ljbGVFdmVudEFyZ3NNYXBbVF1dKSB7XG4gICAgZm9yIChjb25zdCBoYW5kbGVyIG9mIHRoaXMuX2V4cGFuc2lvbkdhbWVFdmVudEhhbmRsZXJzW3RyaWdnZXJdID8/IFtdKSB7XG4gICAgICBhd2FpdCBoYW5kbGVyKHtcbiAgICAgICAgY2FyZFNvdXJjZUNvbnRyb2xsZXI6IHRoaXMuX2NhcmRTb3VyY2VDb250cm9sbGVyLFxuICAgICAgICBmaW5kQ2FyZHM6IHRoaXMuX2ZpbmRDYXJkcyxcbiAgICAgICAgY2FyZFByaWNlQ29udHJvbGxlcjogdGhpcy5jYXJkUHJpY2VDb250cm9sbGVyLFxuICAgICAgICBjYXJkTGlicmFyeTogdGhpcy5fY2FyZExpYnJhcnksXG4gICAgICAgIG1hdGNoOiB0aGlzLl9tYXRjaCxcbiAgICAgICAgcmVhY3Rpb25NYW5hZ2VyOiB0aGlzLFxuICAgICAgICBydW5HYW1lQWN0aW9uRGVsZWdhdGU6IHRoaXMucnVuR2FtZUFjdGlvbkRlbGVnYXRlLFxuICAgICAgfSwgLi4uYXJncylcbiAgICB9XG4gIH1cbiAgXG4gIGFzeW5jIHJ1bkNhcmRMaWZlY3ljbGVFdmVudDxUIGV4dGVuZHMgQ2FyZExpZmVjeWNsZUV2ZW50Pih0cmlnZ2VyOiBULCBhcmdzOiBDYXJkTGlmZWN5Y2xlRXZlbnRBcmdNYXBbVF0pIHtcbiAgICBjb25zdCBjYXJkID0gdGhpcy5fY2FyZExpYnJhcnkuZ2V0Q2FyZChhcmdzLmNhcmRJZCk7XG4gICAgXG4gICAgY29uc3QgZm4gPSBjYXJkTGlmZWN5Y2xlTWFwW2NhcmQuY2FyZEtleV0/Llt0cmlnZ2VyXTtcbiAgICBpZiAoIWZuKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIFxuICAgIGNvbnNvbGUubG9nKGBbUkVBQ1RJT04gTUFOQUdFUl0gcnVubmluZyBsaWZlY3ljbGUgdHJpZ2dlciAnJHt0cmlnZ2VyfScgZm9yIGNhcmQgJHtjYXJkfWApO1xuICAgIFxuICAgIGF3YWl0IGZuKHtcbiAgICAgIGNhcmRTb3VyY2VDb250cm9sbGVyOiB0aGlzLl9jYXJkU291cmNlQ29udHJvbGxlcixcbiAgICAgIHJ1bkdhbWVBY3Rpb25EZWxlZ2F0ZTogdGhpcy5ydW5HYW1lQWN0aW9uRGVsZWdhdGUsXG4gICAgICBjYXJkUHJpY2VDb250cm9sbGVyOiB0aGlzLmNhcmRQcmljZUNvbnRyb2xsZXIsXG4gICAgICBjYXJkTGlicmFyeTogdGhpcy5fY2FyZExpYnJhcnksXG4gICAgICBtYXRjaDogdGhpcy5fbWF0Y2gsXG4gICAgICByZWFjdGlvbk1hbmFnZXI6IHRoaXMsXG4gICAgICBmaW5kQ2FyZHM6IHRoaXMuX2ZpbmRDYXJkc1xuICAgIH0sIGFyZ3MgYXMgYW55KTtcbiAgfVxuICBcbiAgYXN5bmMgcnVuVHJpZ2dlcih7IHRyaWdnZXIsIHJlYWN0aW9uQ29udGV4dCB9OiB7IHRyaWdnZXI6IFJlYWN0aW9uVHJpZ2dlciwgcmVhY3Rpb25Db250ZXh0PzogYW55IH0pIHtcbiAgICByZWFjdGlvbkNvbnRleHQgPz89IHt9O1xuICAgIFxuICAgIC8vIG5vdyB3ZSBnZXQgdGhlIG9yZGVyIG9mIHBsYXllcnMgdGhhdCBjb3VsZCBiZSBhZmZlY3RlZCBieSB0aGUgcGxheSAoaW5jbHVkaW5nIHRoZSBjdXJyZW50IHBsYXllciksXG4gICAgLy8gdGhlbiBnZXQgcmVhY3Rpb25zIGZvciB0aGVtIGFuZCBydW4gdGhlbVxuICAgIGNvbnN0IHRhcmdldE9yZGVyID0gZ2V0T3JkZXJTdGFydGluZ0Zyb20oXG4gICAgICB0aGlzLl9tYXRjaC5wbGF5ZXJzLFxuICAgICAgdGhpcy5fbWF0Y2guY3VycmVudFBsYXllclR1cm5JbmRleCxcbiAgICApO1xuICAgIFxuICAgIGZvciAoY29uc3QgdGFyZ2V0UGxheWVyIG9mIHRhcmdldE9yZGVyKSB7XG4gICAgICBjb25zb2xlLmxvZyhgW1JFQUNUSU9OIE1BTkFHRVJdIGNoZWNraW5nICcke3RyaWdnZXIuZXZlbnRUeXBlfScgcmVhY3Rpb25zIGZvciAke3RhcmdldFBsYXllcn1gKTtcbiAgICAgIFxuICAgICAgY29uc3QgdXNlZFJlYWN0aW9uSWRzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgICBjb25zdCBibG9ja2VkQ2FyZEtleXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICAgIFxuICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgY29uc3QgcmVhY3Rpb25zID0gKGF3YWl0IHRoaXMuZ2V0UmVhY3Rpb25zRm9yUGxheWVyKFxuICAgICAgICAgIHRyaWdnZXIsXG4gICAgICAgICAgdGFyZ2V0UGxheWVyLmlkLFxuICAgICAgICApKS5maWx0ZXIoKHIpID0+IHtcbiAgICAgICAgICBjb25zdCBrZXkgPSByLmdldFNvdXJjZUtleSgpO1xuICAgICAgICAgIHJldHVybiAhdXNlZFJlYWN0aW9uSWRzLmhhcyhyLmlkKSAmJiAhYmxvY2tlZENhcmRLZXlzLmhhcyhrZXkpO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKGBbUkVBQ1RJT04gTUFOQUdFUl0gJHt0YXJnZXRQbGF5ZXJ9IGhhcyAke3JlYWN0aW9ucy5sZW5ndGh9IHJlbWFpbmluZyByZWFjdGlvbnNgKTtcbiAgICAgICAgXG4gICAgICAgIGlmICghcmVhY3Rpb25zLmxlbmd0aCkgYnJlYWs7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBjb21wdWxzb3J5UmVhY3Rpb25zID0gcmVhY3Rpb25zLmZpbHRlcihyID0+IHIuY29tcHVsc29yeSAmJiAhci5zeXN0ZW0pO1xuICAgICAgICBcbiAgICAgICAgY29uc3Qgc3lzdGVtUmVhY3Rpb25zID0gcmVhY3Rpb25zLmZpbHRlcihyID0+IHIuc3lzdGVtKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChzeXN0ZW1SZWFjdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBzeXN0ZW1SZWFjdGlvbiBvZiBzeXN0ZW1SZWFjdGlvbnMpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbUkVBQ1RJT04gTUFOQUdFUl0gcnVubmluZyBzeXN0ZW0gcmVhY3Rpb24gJHtzeXN0ZW1SZWFjdGlvbi5pZH0gZm9yICR7dGFyZ2V0UGxheWVyfWApO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5ydW5SZWFjdGlvbihzeXN0ZW1SZWFjdGlvbiwgdHJpZ2dlciwgdGFyZ2V0UGxheWVyLCByZWFjdGlvbkNvbnRleHQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbGV0IHNlbGVjdGVkUmVhY3Rpb246IFJlYWN0aW9uIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgICAgICBcbiAgICAgICAgY29uc3Qgc2hvdWxkUHJvbXB0ID0gKFxuICAgICAgICAgIHJlYWN0aW9ucy5sZW5ndGggPiAxICYmXG4gICAgICAgICAgKFxuICAgICAgICAgICAgY29tcHVsc29yeVJlYWN0aW9ucy5sZW5ndGggIT09IHJlYWN0aW9ucy5sZW5ndGggfHwgLy8gbWl4IG9mIGNvbXB1bHNvcnkgKyBvcHRpb25hbFxuICAgICAgICAgICAgIWNvbXB1bHNvcnlSZWFjdGlvbnMuZXZlcnkociA9PiByLmdldFNvdXJjZUtleSgpID09PSBjb21wdWxzb3J5UmVhY3Rpb25zWzBdLmdldFNvdXJjZUtleSgpKSAvLyBkaWZmZXJlbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2FyZHNcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgICAgICAvLyB3aGVuIG11bHRpcGxlIHJlYWN0aW9ucyBjYW4gb2NjdXIsIHRoZSB1c2VyIGNob29zZXMgdW5sZXNzIHRoZXkgYXJlIGFsbCBjb21wdWxzb3J5XG4gICAgICAgIC8vIGFuZCB0aGUgc2FtZSBjYXJkXG4gICAgICAgIGlmIChzaG91bGRQcm9tcHQgfHwgKHJlYWN0aW9ucy5sZW5ndGggPT09IDEgJiYgY29tcHVsc29yeVJlYWN0aW9ucy5sZW5ndGggPT09IDApKSB7XG4gICAgICAgICAgY29uc3QgZ3JvdXBlZCA9IGdyb3VwUmVhY3Rpb25zQnlDYXJkS2V5KHJlYWN0aW9ucyk7XG4gICAgICAgICAgY29uc3QgYWN0aW9uQnV0dG9ucyA9IGJ1aWxkQWN0aW9uQnV0dG9ucyhncm91cGVkLCB0aGlzLl9jYXJkTGlicmFyeSk7XG4gICAgICAgICAgY29uc3QgYWN0aW9uTWFwID0gYnVpbGRBY3Rpb25NYXAoZ3JvdXBlZCk7XG4gICAgICAgICAgXG4gICAgICAgICAgY29uc29sZS5sb2coYFtSRUFDVElPTiBNQU5BR0VSXSBwcm9tcHRpbmcgJHt0YXJnZXRQbGF5ZXJ9IHRvIGNob29zZSByZWFjdGlvbmApO1xuICAgICAgICAgIFxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucnVuR2FtZUFjdGlvbkRlbGVnYXRlKCd1c2VyUHJvbXB0Jywge1xuICAgICAgICAgICAgcGxheWVySWQ6IHRhcmdldFBsYXllci5pZCxcbiAgICAgICAgICAgIGFjdGlvbkJ1dHRvbnMsXG4gICAgICAgICAgICBwcm9tcHQ6ICdDaG9vc2UgcmVhY3Rpb24/JyxcbiAgICAgICAgICB9KSBhcyB7IGFjdGlvbjogbnVtYmVyIH07XG4gICAgICAgICAgXG4gICAgICAgICAgaWYgKHJlc3VsdC5hY3Rpb24gPT09IDApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbUkVBQ1RJT04gTUFOQUdFUl0gJHt0YXJnZXRQbGF5ZXJ9IGNob3NlIG5vdCB0byByZWFjdGApO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYFtSRUFDVElPTiBNQU5BR0VSXSAke3RhcmdldFBsYXllcn0gcmVhY3RzIHdpdGggJHthY3Rpb25NYXAuZ2V0KHJlc3VsdC5hY3Rpb24pfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICBzZWxlY3RlZFJlYWN0aW9uID0gYWN0aW9uTWFwLmdldChyZXN1bHQuYWN0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBzZWxlY3RlZFJlYWN0aW9uID0gY29tcHVsc29yeVJlYWN0aW9uc1swXTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKCFzZWxlY3RlZFJlYWN0aW9uKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGBbUkVBQ1RJT04gTUFOQUdFUl0gcmVhY3Rpb24gbm90IGZvdW5kIGluIGFjdGlvbiBtYXBgKTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgYXdhaXQgdGhpcy5ydW5SZWFjdGlvbihzZWxlY3RlZFJlYWN0aW9uLCB0cmlnZ2VyLCB0YXJnZXRQbGF5ZXIse1xuICAgICAgICAgIGNhcmRTb3VyY2VDb250cm9sbGVyOiB0aGlzLl9jYXJkU291cmNlQ29udHJvbGxlcixcbiAgICAgICAgICBmaW5kQ2FyZHM6IHRoaXMuX2ZpbmRDYXJkcyxcbiAgICAgICAgICByZWFjdGlvbk1hbmFnZXI6IHRoaXMsXG4gICAgICAgICAgY2FyZFByaWNlQ29udHJvbGxlcjogdGhpcy5jYXJkUHJpY2VDb250cm9sbGVyLFxuICAgICAgICAgIGlzUm9vdExvZzogZmFsc2UsXG4gICAgICAgICAgcnVuR2FtZUFjdGlvbkRlbGVnYXRlOiB0aGlzLnJ1bkdhbWVBY3Rpb25EZWxlZ2F0ZSxcbiAgICAgICAgICB0cmlnZ2VyLFxuICAgICAgICAgIGNhcmRMaWJyYXJ5OiB0aGlzLl9jYXJkTGlicmFyeSxcbiAgICAgICAgICBtYXRjaDogdGhpcy5fbWF0Y2gsXG4gICAgICAgICAgcmVhY3Rpb246IHNlbGVjdGVkUmVhY3Rpb24sXG4gICAgICAgIH0sIHJlYWN0aW9uQ29udGV4dCk7XG4gICAgICAgIFxuICAgICAgICB1c2VkUmVhY3Rpb25JZHMuYWRkKHNlbGVjdGVkUmVhY3Rpb24uaWQpO1xuICAgICAgICBcbiAgICAgICAgaWYgKCFzZWxlY3RlZFJlYWN0aW9uLmFsbG93TXVsdGlwbGVJbnN0YW5jZXMpIHtcbiAgICAgICAgICBibG9ja2VkQ2FyZEtleXMuYWRkKHNlbGVjdGVkUmVhY3Rpb24uZ2V0U291cmNlS2V5KCkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIFxuICBwcml2YXRlIGFzeW5jIHJ1blJlYWN0aW9uPFQgZXh0ZW5kcyBUcmlnZ2VyRXZlbnRUeXBlPihyZWFjdGlvbjogUmVhY3Rpb24sIHRyaWdnZXI6IFJlYWN0aW9uVHJpZ2dlcjxUPiwgdGFyZ2V0UGxheWVyOiBQbGF5ZXIsIGNvbnRleHQ6IFRyaWdnZXJlZEVmZmVjdENvbnRleHQ8VD4sIHJlYWN0aW9uQ29udGV4dD86IGFueSkge1xuICAgIGNvbnN0IHJlYWN0aW9uUmVzdWx0ID0gYXdhaXQgcmVhY3Rpb24udHJpZ2dlcmVkRWZmZWN0Rm4oe1xuICAgICAgY2FyZFNvdXJjZUNvbnRyb2xsZXI6IHRoaXMuX2NhcmRTb3VyY2VDb250cm9sbGVyLFxuICAgICAgZmluZENhcmRzOiB0aGlzLl9maW5kQ2FyZHMsXG4gICAgICByZWFjdGlvbk1hbmFnZXI6IHRoaXMsXG4gICAgICBjYXJkUHJpY2VDb250cm9sbGVyOiB0aGlzLmNhcmRQcmljZUNvbnRyb2xsZXIsXG4gICAgICBpc1Jvb3RMb2c6IGZhbHNlLFxuICAgICAgcnVuR2FtZUFjdGlvbkRlbGVnYXRlOiB0aGlzLnJ1bkdhbWVBY3Rpb25EZWxlZ2F0ZSxcbiAgICAgIHRyaWdnZXIsXG4gICAgICBjYXJkTGlicmFyeTogdGhpcy5fY2FyZExpYnJhcnksXG4gICAgICBtYXRjaDogdGhpcy5fbWF0Y2gsXG4gICAgICByZWFjdGlvbixcbiAgICB9KTtcbiAgICBcbiAgICAvLyByaWdodCBub3cgdGhlIG9ubHkgY2FyZCB0aGF0IGNyZWF0ZWQgdGhhdCBoYXMgYSByZWFjdGlvbiB0aGF0IHRoZVxuICAgIC8vIGNhcmQgdHJpZ2dlcmluZyBpdCBuZWVkcyB0byBrbm93IGFib3V0IGlzIG1vYXQgZ2l2aW5nIGltbXVuaXR5LlxuICAgIC8vIGV2ZXJ5IG90aGVyIHJlYWN0aW9uIGp1c3QgcmV0dXJucyB1bmRlZmluZWQuIHNvIGlmIHRoZSByZWFjdGlvblxuICAgIC8vIGRvZXNuJ3QgZ2l2ZSBhIHJlc3VsdCwgZG9uJ3Qgc2V0IGl0IG9uIHRoZSBjb250ZXh0LiB0aGlzIG1pZ2h0XG4gICAgLy8gaGF2ZSB0byBleHBhbmQgbGF0ZXIuXG4gICAgaWYgKHJlYWN0aW9uUmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlYWN0aW9uQ29udGV4dFt0YXJnZXRQbGF5ZXIuaWRdID0ge1xuICAgICAgICByZWFjdGlvbixcbiAgICAgICAgdHJpZ2dlcixcbiAgICAgICAgcmVzdWx0OiByZWFjdGlvblJlc3VsdCxcbiAgICAgIH07XG4gICAgfVxuICAgIFxuICAgIGlmIChyZWFjdGlvbi5vbmNlKSB7XG4gICAgICBjb25zb2xlLmxvZyhgW1JFQUNUSU9OIE1BTkFHRVJdIHNlbGVjdGVkIHJlYWN0aW9uIGlzIHNpbmdsZS11c2UsIHVucmVnaXN0ZXJpbmcgaXRgKTtcbiAgICAgIHRoaXMudW5yZWdpc3RlclRyaWdnZXIocmVhY3Rpb24uaWQpO1xuICAgIH1cbiAgfVxufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQWlCLFFBQVEsUUFBdUIseUJBQXlCO0FBQ3pFLFNBT0UsUUFBUSxRQUtILGlCQUFpQjtBQUV4QixTQUFTLG9CQUFvQixRQUFRLHlDQUF5QztBQUM5RSxTQUFTLHVCQUF1QixRQUFRLG1DQUFtQztBQUMzRSxTQUFTLGtCQUFrQixRQUFRLDRCQUE0QjtBQUMvRCxTQUFTLGNBQWMsUUFBUSx3QkFBd0I7QUFDdkQsU0FBUyxnQkFBZ0IsUUFBUSwyQkFBMkI7QUFLNUQsT0FBTyxNQUFNOzs7Ozs7OztFQUNILFdBQTRCO0VBQzVCLDRCQUE0STtFQUVwSixZQUNFLEFBQWlCLHFCQUEyQyxFQUM1RCxBQUFpQixVQUF1QixFQUN4QyxBQUFpQixtQkFBNkMsRUFDOUQsQUFBaUIsVUFBc0IsRUFDdkMsQUFBaUIsTUFBYSxFQUM5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
// denoCacheMetadata=8564005968201019053,787085009102207412