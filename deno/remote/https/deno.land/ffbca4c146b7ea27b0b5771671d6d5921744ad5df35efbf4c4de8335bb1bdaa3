type OriginOption = boolean | string | RegExp | (string | RegExp)[];

export interface CorsOptions {
  origin?: OriginOption;
  methods?: string | string[];
  allowedHeaders?: string | string[];
  exposedHeaders?: string | string[];
  credentials?: boolean;
  maxAge?: number;
}

export function addCorsHeaders(
  headers: Headers,
  opts: CorsOptions,
  req: Request,
) {
  addOrigin(opts, headers, req);
  addCredentials(opts, headers);
  addExposedHeaders(opts, headers);

  if (req.method === "OPTIONS") {
    addMethods(opts, headers);
    addAllowedHeaders(opts, headers, req);
    addMaxAge(opts, headers);
  }
}

function join(arg: string | string[]) {
  return Array.isArray(arg) ? arg.join(",") : arg;
}

function isOriginAllowed(allowedOrigin: OriginOption, origin: string): boolean {
  if (Array.isArray(allowedOrigin)) {
    for (let i = 0; i < allowedOrigin.length; i++) {
      if (isOriginAllowed(allowedOrigin[i], origin)) {
        return true;
      }
    }
    return false;
  } else if (typeof allowedOrigin === "string") {
    return allowedOrigin === origin;
  } else if (allowedOrigin instanceof RegExp) {
    return allowedOrigin.test(origin);
  } else {
    return !!allowedOrigin;
  }
}

function addOrigin(opts: CorsOptions, headers: Headers, req: Request) {
  const origin = req.headers.get("origin")!;
  const allowedOrigin = opts.origin;

  if (!allowedOrigin || allowedOrigin === "*") {
    headers.set("Access-Control-Allow-Origin", "*");
  } else if (typeof allowedOrigin === "string") {
    headers.set("Access-Control-Allow-Origin", allowedOrigin);
    headers.append("Vary", "Origin");
  } else {
    const isAllowed = isOriginAllowed(allowedOrigin, origin);
    headers.set("Access-Control-Allow-Origin", isAllowed ? origin : "false");
    headers.append("Vary", "Origin");
  }
}

function addMethods(opts: CorsOptions, headers: Headers) {
  if (opts.methods) {
    headers.set("Access-Control-Allow-Methods", join(opts.methods));
  }
}

function addAllowedHeaders(opts: CorsOptions, headers: Headers, req: Request) {
  if (opts.allowedHeaders) {
    headers.set("Access-Control-Allow-Headers", join(opts.allowedHeaders));
    return;
  }
  const requestedHeaders = req.headers.get("access-control-request-headers");
  if (requestedHeaders) {
    headers.append("Vary", "Access-Control-Request-Headers");
    headers.set("Access-Control-Allow-Headers", requestedHeaders);
  }
}

function addExposedHeaders(opts: CorsOptions, headers: Headers) {
  if (opts.exposedHeaders) {
    headers.set("Access-Control-Expose-Headers", join(opts.exposedHeaders));
  }
}

function addCredentials(opts: CorsOptions, headers: Headers) {
  if (opts.credentials) {
    headers.set("Access-Control-Allow-Credentials", "true");
  }
}

function addMaxAge(opts: CorsOptions, headers: Headers) {
  if (opts.maxAge) {
    headers.set("Access-Control-Max-Age", opts.maxAge.toString());
  }
}

// denoCacheMetadata={"headers":{"vary":"Accept-Encoding, Origin","x-amz-replication-status":"COMPLETED","x-content-type-options":"nosniff","cross-origin-embedder-policy":"same-origin","server":"deno/gcp-us-east4","age":"12809340","content-type":"application/typescript; charset=utf-8","via":"http/2 edgeproxy-h","x-amz-cf-id":"rgMvpML6BEsDpSNHPgKa-9L7q3nMx6UttfJY10NZuxXAYHPHNt-fzA==","content-security-policy":"default-src 'none'; style-src 'unsafe-inline'; sandbox","content-length":"2905","last-modified":"Thu, 09 Jan 2025 07:38:35 GMT","server-timing":"fetchSource;dur=36","x-amz-server-side-encryption":"AES256","x-frame-options":"DENY","cross-origin-resource-policy":"same-origin","cross-origin-opener-policy":"same-origin","date":"Wed, 29 Jan 2025 15:36:35 GMT","strict-transport-security":"max-age=63072000; includeSubDomains; preload","x-amz-cf-pop":"IAD61-P1","referrer-policy":"strict-origin-when-cross-origin","accept-ranges":"bytes","x-amz-version-id":"LzrtGBDzQxL61COUNzym12J7jYNnGV65","x-cache":"Hit from cloudfront","etag":"\"282a78ea56ed4aa048f28969d94050ad\"","cache-control":"public, max-age=31536000, immutable","access-control-allow-origin":"*"},"url":"https://deno.land/x/socket_io@0.2.1/packages/engine.io/lib/cors.ts","time":1750974334}